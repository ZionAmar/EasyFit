<%- include('top') %>

<div class="container">
    <h2><%= meeting.name %></h2>
    <p><strong>××“×¨×™×š:</strong> <%= meeting.trainer_name %></p>
    <p><strong>×—×“×¨:</strong> <%= meeting.room_name %> (×§×™×‘×•×œ×ª: <%= meeting.capacity %>)</p>
    <p><strong>×ª××¨×™×š:</strong> <%= meeting.date %></p>
    <p><strong>×›××•×ª ××©×ª×ª×¤×™× ××¤×©×¨×™×ª:</strong> <%= meeting.participant_count %></p>
    <p><strong>×©×¢×”:</strong> <%= meeting.start_time %> - <%= meeting.end_time %></p>
    <p><strong>××©×ª×ª×¤×™× × ×•×›×—×™×™×:</strong> <%= currentCount %></p>

    <% if (user && user.role === 'member') { %>
      <!-- ×¨×§ ×œ×—× ×™×š ××•×¦×’ ×›×¤×ª×•×¨ ×”×”×¨×©××” -->
      <form id="join-form">
          <input type="hidden" name="meeting_id" value="<%= meeting.id %>">
          <input type="hidden" name="user_id" value="<%= user.id %>">
          <button type="submit">×”×¦×˜×¨×£ ×œ××¤×’×©</button>
      </form>
    <% } %>

    <% if (user && user.role === 'admin') { %>
      <!-- ×¨×§ ×œ××“××™×Ÿ ××•×¦×’×™× ×›×¤×ª×•×¨×™ ×¢×¨×™×›×” ×•××—×™×§×” -->
      <div style="margin-top: 20px;">
        <a href="/meetings/edit/<%= meeting.id %>"><button>âœ ×¢×¨×•×š</button></a>
        <form action="/meetings/delete/<%= meeting.id %>" method="POST" style="display:inline;">
          <button type="submit" onclick="return confirm('×œ××—×•×§ ××ª ×”××¤×’×© <%= meeting.name %>?');">ğŸ—‘ ××—×§</button>
        </form>
      </div>
    <% } %>
</div>

<% if (user && user.role === 'member') { %>
<script>
document.getElementById("join-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const params = new URLSearchParams(formData);

  try {
    const res = await fetch("/participation/join", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: params
    });

    const text = await res.text();

    if (res.ok) {
      alert(text);
    } else {
      const json = JSON.parse(text);
      if (json.error.includes("×¨×©×™××ª ×”××ª× ×”")) {
        if (confirm(json.error)) {
          const res2 = await fetch("/participation/join-waiting", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: params
          });
          const msg = await res2.text();
          alert(msg);
        }
      } else {
        alert(json.error);
      }
    }
  } catch (err) {
    alert("×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×¤×¢×•×œ×”.");
    console.error(err);
  }
});
</script>
<% } %>

<%- include('bottom') %>
